package de.culture4life.luca.testing.provider.opentestcheck;

import de.culture4life.luca.registration.RegistrationData;
import de.culture4life.luca.testing.TestResultParsingException;
import de.culture4life.luca.testing.TestResultVerificationException;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.robolectric.annotation.Config;

import androidx.test.runner.AndroidJUnit4;

import static org.junit.Assert.assertEquals;

@Config(sdk = 28)
@RunWith(AndroidJUnit4.class)
public class OpenTestCheckTestResultProviderTest {

    public static final String VALID_TEST_RESULT_TICKET_IO = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiMTZhM2U0YjkyY2E0NjYwYzQxYjg4MDU3Mjc2YzM1ZGUzOGI2ZGZlN2FkY2VkMzZjZGUxZjA3OWE2ODY4YTFhMyIsInQiOjE2MjA4MDIwNTIsImMiOiJmIiwiciI6Im4iLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJEci4gRGF2aWQiLCJlZCI6ImhvaktYcFErMERhZGpaWWlUdktWWmR6d21WVDcyWHU1R2xZTXNVYnJPN2M3REhZY1c1Y1Y2ajhaalpMRVpGTE9wS3FTK1AzZllzTEJtMzRJMUREV09sR2x6N1RrUHROeG5cL3JhcnN3ZVA0bkhlUzhhcFVsUEdwUnAyVEl2R1E9PSJ9.IKHZusBnGBc12b3by5SL6FXOdeufyU_9arwmx9_L0JOlXXY1Q9HpS5oCzLJ9iy5Wlm7wvYkao6CT49fgaDzmQL4zTubQo7xpJGc19EWIL0z5o_HaYkN74KrxG114VsLLVPgps50MzYv_qvhr0qe5DABHFswUMKGhyLxJyZFsMfMPI4WY-REFO6zWCTg9uS4mLDEXz1weJ_0ZJj4j5jW-3FzX-Hzq9iovLT7PyVIiK318iP0pc7vSP9V-8bvgqnHvinKUEw0FdxjRN0V_Isd8M2E5Xn64TvUeISMd6f5Nk3KytIW5jTaZg_E7z-ldzz5w12ZH3uITx7ocxjahdChE2w";
    public static final String EXPIRED_TEST_RESULT_TICKET_IO = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiYTZhODVkODUyZTA1OTFkZjM2ODUwZTFmMDc1MTFkZWE0MmFjYjAxMjljNzFkZjk1ZTM2YWVkNzhkYWU5ZTNhOCIsInQiOjE2MjAyNzU3NDAsImMiOiJwIiwiciI6InAiLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJQcm9mLiBIYW5zIiwiZWQiOiJpTHhpSFZzck5oZFh6UDNoeEZkd1p3Z1ludDVGTUYzVXo3MmJHOHMxcytxV2hzZEgxeGJ4R1Z0SHZzbVwvZkRLXC9zWUczdVwvR0pKd3BXTldSZ2xHOGs0SnhyKytCeDBwWStudjlqb0diWm5lWEt4Ulp6T3RSWnlxeEY2cExrIn0.WocR6aa8EX1WEOKxES_gFnvfJnrg6xLzm1cwZ453StqubQPlMjG-JdZofVa4NgTRUCrxDvcQd8M-wQxksM79Dpy0_tOP2mHA59V5LTsVSVzk7teS6cTGhy1nGqZIfu3ORvOqTvxJmuBtT-Z8TGnJzkTTMNx_t8mPSBTHCJX9YQE0APXSnusiy5LF4iQTpYrgKEH0IZTT4gIx6-SbNpkuVmJE6RxVvjAdnlnTS6lqtr9jplaNw8L6gDw5s0zZ5z8xytuWvceRap_GOTeCxdmg-8f4EghjMJFea8T5WwfZY4BDJbEawsAcOY-ErS4Ey3M_W8PYaPTZWmClOiJGsCeU8w";
    public static final String VALID_TEST_RESULT_TICKET_IO_2 = "https://testverify.io/v1#eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiYTZhODVkODUyZTA1OTFkZjM2ODUwZTFmMDc1MTFkZWE0MmFjYjAxMjljNzFkZjk1ZTM2YWVkNzhkYWU5ZTNhOCIsInQiOjE2MjAyNzU3NDAsImMiOiJwIiwiciI6InAiLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJQcm9mLiBIYW5zIiwiZWQiOiJpTHhpSFZzck5oZFh6UDNoeEZkd1p3Z1ludDVGTUYzVXo3MmJHOHMxcytxV2hzZEgxeGJ4R1Z0SHZzbVwvZkRLXC9zWUczdVwvR0pKd3BXTldSZ2xHOGs0SnhyKytCeDBwWStudjlqb0diWm5lWEt4Ulp6T3RSWnlxeEY2cExrIn0.WocR6aa8EX1WEOKxES_gFnvfJnrg6xLzm1cwZ453StqubQPlMjG-JdZofVa4NgTRUCrxDvcQd8M-wQxksM79Dpy0_tOP2mHA59V5LTsVSVzk7teS6cTGhy1nGqZIfu3ORvOqTvxJmuBtT-Z8TGnJzkTTMNx_t8mPSBTHCJX9YQE0APXSnusiy5LF4iQTpYrgKEH0IZTT4gIx6-SbNpkuVmJE6RxVvjAdnlnTS6lqtr9jplaNw8L6gDw5s0zZ5z8xytuWvceRap_GOTeCxdmg-8f4EghjMJFea8T5WwfZY4BDJbEawsAcOY-ErS4Ey3M_W8PYaPTZWmClOiJGsCeU8w";
    public static final String VALID_TEST_RESULT_TICKET_IO_SPECIAL_CHARS = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiZjQyMGYwMmYxYjk0NjkyZmRkZjkwOTUwNjk4N2U1NDdiYjg2OWMzYWMzMGM5NWQ5MWM3Y2JlNWYxZDJjZjE1ZSIsInQiOjE2MjA5ODYyNzgsImMiOiJwIiwiciI6InAiLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJQcm9mLiBEci4gQ29yb25hZmlnaHQiLCJlZCI6ImJXaitIMkkxbWtUU2hmbVZGSlwvYlFpQWVuRVAyTk44OTFLUEloeDdyNlRTbEdnTndFblVKTERsTVJSYnd3TVJcL0xxOTBldzk2N1o2aWozc3NYcjYyaXprWVU0bG96NWh1WWZUSVI2TndkQktJWCt3cXloTVE0VjBPcU5kekc3WW1rb0k9In0.BJXB91NB0RDQhgx2nrvUltasO-7OgT_7Ll9JxguS_TuLmIwrTJZ0yeurIChCYqK6j4xWnlpt-BzuW_a7ZSrgOVILxSZ7UUBGjXlEdfJAyudWDiAIVg_h_yA0TPK2R7Ngpope3AaY5wjj99CairtugPB1Bb3a7hn_Hmx8nrqCUVMsEqlZC42DaKxnGyjJT2tTNrc9SZ9SUvCSTSEbcNVTROqfszl5rfe7AfHtR_OK2gQhs56DFB1YYznkIP4Wz6PJMPjKT6sC6WPgb08vh4eunm_RH_b4kbd4qTioTqBEJWDI_lKthpb6sXtnWbgzeQA7FpkfEKjmhTJbkPZ_wuPmlA";
    public static final String VALID_TEST_RESULT_SODA = "eyJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiODExYTlhNjk0N2E5NGUxYjhhNjE3OTM4NWVmMmIwYTA3MzE4Zjk4MjRhMzZjZTVkYmE5YmY4ZGVkZDNmZGFmNyIsInQiOjE2MjA2NDYxODAsImMiOiJmIiwiciI6Im4iLCJsIjoiVGVzdGthbGVuZGVyIiwiZCI6IkhhbWVkIEhpbXNlbGYifQ.N6xoHuea6j1nUimMeiHVtlWlfSKeA4hu-Oa9pb_AY-6zg_auCcJmH4iD94lU8lDXt11SXASF8DsGsysvhjKQuqTyQmPpcAvgfRv-Z1IjFCv_GK41Kdt77BeKTAY8vV4RpjNzNE6VKCUaT6bS88EAcEO6TvM1u4IzKrUExD0J-ik-YuJHOefbS7gQv7LFzMrLO3u3U_7fItKLPQodvFPpMxaBW2tRWJ0gdGNGN4kAvqzo8apayL6qGRDSgRRdLBD_6K43X6DVpYNmCUdldfzcrnsSTsEXWZu7zbSo44WLIReSDHQBx5xs628_AaMlkv8jSVhxf1r9ssUv8H1x2FA1ovzNEUrfp-0CSNb1hS_EOHWOsE4AAFH1bRU1VdVco2rglOqrYXSAmbtEOTO-3CbuwfpWJ8BWjVhmynsNznD5XQhYxqwyqHwfb_DAcewHK-aKvwyLOyT0MvDo5e285FCPkF2F1ZZzI5rDzVFrNLfzQOCYKpJQd0pHkvn0l0Zx-lFK18rbYnRQG12Bao6uKBE5dGCdQNSeaZZKGCN3IrzjUDt1dR2H36vTHB3D4nkkXzQR184cfG-Fb9IpLl1fJ-U6f2ah0TlOBCEYVcrCAqr1Y0PFgZlcv8StcNPhFgZimHbbGF5om0ZyGhltZurC1pVmKvgbHptxjUTtCErYi1FXwlE";
    public static final String VALID_TEST_RESULT_MEIN_CORONA_TEST = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJjIjoiZiIsImwiOiJNZWluIENvcm9uYSBTY2huZWxsdGVzdCIsIm4iOiJlM2FkY2RmZmM0ZGUzYWIzNDI1YmJjZTlmZDg3NzU4ZjMwNDk1OWVhNWE0YTc0MmEzMGE5MjlhODhmOWFhZjgzIiwidCI6MTYyMDgzNjA0NiwidiI6MiwiciI6Im4ifQ.HCoYdg9j8LL0QzIe2MJ_6H_GRtX4wTRbzZubaJW4eetcSAvaJChYs0Qj6cxFn8DkGtqYonSwTkkGoCniLuFez6fZKuc4FEEhMCtgaoqhT1XRtMokV7uMlnRQKE7rOsKHzMJi2FYNdDCKcIae4IbVwRaSCdaDsmNfXncBN_TFH7tm7Zmp6w56E6_CqSBP8HsuVK2NnKjFmAYjMQ1o_PVtgeYzc55nn5AzSBCVNIBHALUkbXzAbOh8Io4yHCxJqMEOoTuo6MAnD3w3FdQUddu73nZ7tVuS_lbRQ_WaXK4XfetuLlIWOu8tmIqE55JLZlzBbpPmG1eXe7gP2rKJypkmgHik99S7sBG-xBn_u1HmJwcbvEOnjTNK4o-UXyGBLQvOfBgngzLlFOUKrM_iQLIsBAycNlYdMgj2Xl8pww7NrM8Wfkk444l2CmIHFumJ5xaeyUD10tLMBfovW9XOHeqNDUAxivR9f63KEe9Wh3IrjhhT_fN5x1rrArtj1AzbHI_d27qC0lgOJI-BZmxTSUxBwyM2O1FLhu_ng4HU1A-Znc3pwZlcyrE1lWZbNsO6fQD_CPgf7dWUA_Nt_xMIpdnFDy4XBrxH6Ob0rmlWpNSW98Yd0e5h5DA8NF8Tc98owKTV04sReHze8Vve9pXAEavZKeg4vL71ZjGRr_2RZVFUTE0";
    public static final String VALID_TEST_RESULT_TEST_NOW = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiMDIwMjA4MTg1MzAwYjMyMWVjZWEzNGIwN2YxZmFhYjRjMjRjYmE0MDYzMDk3NDUxMTZjOWM5YmEwNmRiOWYzMyIsInQiOjE2MjAzMzQ5NDMsImMiOiJvIiwiciI6Im4iLCJsIjoiVGVzdCBOT1chIEdtYkgiLCJkIjoiTWF4IE11c3Rlcm1hbm4ifQ.CS33_ocJeaPmReVPZ13I4QXyp2iXzd9uAcHKWT48Y2yXTUiiU2jUTGkuBCt71_0bAPK0e1HfEgOWWR5_L54PqOI9_YIaN-Bm-jgCpHw9ukgeFVhYFIBvk6hLniL5NIey0gVcNd9cO2YrvXeqVy6COHkf7P04qJqxPAD-dv9GWa4_B692qXPI4EvWu49GduFnQtrxMe_HZjnluobaRejC0UJQSjyio1mX4m8SFpQ_Xg0HBaNaMu-t396d6ICHOv5Mv4sL1u_FKTyDT-LsrCQpCmLvSzVdq8JLLPHLH1UapVdytu1DkMn2ehJz7PjTFjV3kG4V9lSrbW_TuloF9uenuX0DCA8iS__PMyY0EVDMH1UldtxUob41-Nb9ZIqgxWyhiUjet0i6siwi6wK3BmGqOxn0mb4JaNWNC3yovSLpAe_IHjuXiYTw86ZajR5LlmKewbFJno1lqmL7JWTAd5AeZPa44hcfMG0dcUl-6Qfv1yUsYAY_hA2JCO16cEuUSV67om7ENyE1a_zh-EgVtX_iuTgocZsnQsdKhzfUawIuKTWYd54wvsM44U-EGu1pqNaarZQOdputlkZCTEklkTPLH8PUl6t6TKtyzW7TseYeP7xCWg7WCQ6EMj_lJi46VNYc-_K30fBL9yWy-cGurt3_EY6Kin_QGvrVpgUO5xRk3tc";
    public static final String UNSUPPORTED_TEST_RESULT = "iLxiHVsrNhdXzP3hxFdwZwgYnt5FMF3Uz72bG8s1s+qWhsdH1xbxGVtHvsm/fDK/sYG3u/GJJwpWNWRglG8k4Jxr++Bx0pY+nv9joGbZneXKxRZzOtRZyqxF6pLk";
    public static final String UNVERIFIED_TEST_RESULT = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ2IjoyLCJuIjoiMjUwYmNjZmZkMWNiNWZlYWY0ODRmZGEzM2Y5NDdiM2Q4ZDcwMDA4M2ZmMjVlMGQ2NGQxMjk3NDQ0MWUzZTM4NCIsInQiOjE2MjA4MDIwMTQsImMiOiJvIiwiciI6Im4iLCJsIjoiQ292aW1lZGljYWwgR21iSCIsImQiOiJEci4gRGF2aWQiLCJlZCI6Iko5Mko3NUkyTXhWTzVVQUVSZHMrTDlybjZoZ0lndVNHUlVhT1RzdElGR1wvbHNDRTBpQ0VLTlZvR0JxMnlpeWpKck0yeFM4ZjhteXJnTUU2Z2V4bHdCeEFGbmpBQ1NoMmRTRU4zK0JiaUxqM1k3U2FmcTQraTJYa0RPZz09In0.n1I0PL7TA7o_8dkS1MM3rxvO3tJEgxz5N4YjPSeb7hRmyhIY-IFW0zMZxSZ4zl4vBUMgBAh5yQgseSlcLZX1xsBs6okr2nuaVtUGNOib79qSMfQBAksc3N47NCqD3VFyqJAzmQjw2KJNZA8dcGau72FIYI-U-9lxmD-J2VWw01kn8wNgGGaAd4xBp9DszEijvtOvr6B6OjyUzsGN-aI55ZCeIgoG50CtiwcM-3zW2s5kN_ph7RR_LRCVVo3oUjlxz3DPrukNOSivaDIZ55CXy-Q6VuSfSuywukw5fRHB8ROUbvjb0wL9uupPJyUhI_KkEKt894UweRJD895HH";

    private OpenTestCheckTestResultProvider testResultProvider;

    @Before
    public void setUp() {
        testResultProvider = new OpenTestCheckTestResultProvider();
    }

    @Test
    public void canParse_validDataTicketIo_emitsTrue() {
        testResultProvider.canParse(VALID_TEST_RESULT_TICKET_IO)
                .test()
                .assertValue(true);
    }

    @Test
    public void canParse_validDataTicketIo2_emitsTrue() {
        testResultProvider.canParse(VALID_TEST_RESULT_TICKET_IO_2)
                .test()
                .assertValue(true);
    }

    @Test
    public void canParse_invalidData_emitsFalse() {
        testResultProvider.canParse(UNSUPPORTED_TEST_RESULT)
                .test()
                .assertValue(false);
    }

    @Test
    public void parse_validDataTicketIo_parsesData() {
        testResultProvider.parse(VALID_TEST_RESULT_TICKET_IO)
                .test()
                .assertValue(testResult -> {
                    assertEquals((Integer) 2, testResult.v);
                    assertEquals("16a3e4b92ca4660c41b88057276c35de38b6dfe7adced36cde1f079a6868a1a3", testResult.n);
                    assertEquals((Integer) 1620802052, testResult.t);
                    assertEquals("f", testResult.c);
                    assertEquals("n", testResult.r);
                    assertEquals("Covimedical GmbH", testResult.l);
                    assertEquals("Dr. David", testResult.d);
                    assertEquals("hojKXpQ+0DadjZYiTvKVZdzwmVT72Xu5GlYMsUbrO7c7DHYcW5cV6j8ZjZLEZFLOpKqS+P3fYsLBm34I1DDWOlGlz7TkPtNxn/rarsweP4nHeS8apUlPGpRp2TIvGQ==", testResult.ed);
                    return true;
                });
    }

    @Test
    public void parse_validDataTicketIo2_parsesData() {
        testResultProvider.parse(VALID_TEST_RESULT_TICKET_IO_2)
                .test()
                .assertValue(testResult -> {
                    assertEquals((Integer) 2, testResult.v);
                    assertEquals("a6a85d852e0591df36850e1f07511dea42acb0129c71df95e36aed78dae9e3a8", testResult.n);
                    assertEquals((Integer) 1620275740, testResult.t);
                    assertEquals("p", testResult.c);
                    assertEquals("p", testResult.r);
                    assertEquals("Covimedical GmbH", testResult.l);
                    assertEquals("Prof. Hans", testResult.d);
                    assertEquals("iLxiHVsrNhdXzP3hxFdwZwgYnt5FMF3Uz72bG8s1s+qWhsdH1xbxGVtHvsm/fDK/sYG3u/GJJwpWNWRglG8k4Jxr++Bx0pY+nv9joGbZneXKxRZzOtRZyqxF6pLk", testResult.ed);
                    return true;
                });
    }

    @Test
    public void parse_invalidData_emitsError() {
        testResultProvider.parse(UNSUPPORTED_TEST_RESULT)
                .test()
                .assertError(TestResultParsingException.class);
    }

    @Test
    public void validate_validDataTicketIo_completes() {
        RegistrationData registrationData = new RegistrationData();
        registrationData.setFirstName("Gianluca");
        registrationData.setLastName("Frontzek");

        testResultProvider.parse(VALID_TEST_RESULT_TICKET_IO)
                .flatMapCompletable(testResult -> testResultProvider.validate(testResult, registrationData))
                .test()
                .assertComplete();
    }

    @Test
    public void validate_validDataWithSpecialCharTicketIo_completes() {
        RegistrationData registrationData = new RegistrationData();
        registrationData.setFirstName("Gianluca");
        registrationData.setLastName("Förster");
        testResultProvider.parse(VALID_TEST_RESULT_TICKET_IO_SPECIAL_CHARS)
                .flatMapCompletable(testResult -> testResultProvider.validate(testResult, registrationData))
                .test()
                .assertComplete();
    }

    @Test
    public void validate_validDataSoda_completes() {
        RegistrationData registrationData = new RegistrationData();
        registrationData.setFirstName("Hamed");
        registrationData.setLastName("Montazeri");

        testResultProvider.parse(VALID_TEST_RESULT_SODA)
                .flatMapCompletable(testResult -> testResultProvider.validate(testResult, registrationData))
                .test()
                .assertComplete();
    }

    @Test
    public void validate_validDataMeinCoronaTest_completes() {
        RegistrationData registrationData = new RegistrationData();
        registrationData.setFirstName("Sebastian");
        registrationData.setLastName("Kowalski");

        testResultProvider.parse(VALID_TEST_RESULT_MEIN_CORONA_TEST)
                .flatMapCompletable(testResult -> testResultProvider.validate(testResult, registrationData))
                .test()
                .assertComplete();
    }

    @Test
    public void validate_validDataTestNow_completes() {
        RegistrationData registrationData = new RegistrationData();
        registrationData.setFirstName("Jannusch");
        registrationData.setLastName("Franke");

        testResultProvider.parse(VALID_TEST_RESULT_TEST_NOW)
                .flatMapCompletable(testResult -> testResultProvider.validate(testResult, registrationData))
                .test()
                .assertComplete();
    }

    @Test
    public void validate_nameMismatch_emitsError() {
        RegistrationData registrationData = new RegistrationData();
        registrationData.setFirstName("Erika");
        registrationData.setLastName("Mustermann");

        testResultProvider.parse(VALID_TEST_RESULT_TICKET_IO)
                .flatMapCompletable(testResult -> testResultProvider.validate(testResult, registrationData))
                .test()
                .assertError(TestResultVerificationException.class);
    }

    @Test
    public void validate_unverifiedData_emitsError() {
        RegistrationData registrationData = new RegistrationData();
        registrationData.setFirstName("Jannusch");
        registrationData.setLastName("Barnech");

        testResultProvider.parse(UNVERIFIED_TEST_RESULT)
                .flatMapCompletable(testResult -> testResultProvider.validate(testResult, registrationData))
                .test()
                .assertError(TestResultVerificationException.class);
    }

}